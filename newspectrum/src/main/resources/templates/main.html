<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="javascript">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì¸í˜ì´ì§€</title>

    <!-- ì™¸ë¶€ ìŠ¤íƒ€ì¼/ìŠ¤í¬ë¦½íŠ¸ -->
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            margin: 0;
            padding: 0;
        }

        /* ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ */
        .section-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            margin: 40px 0 20px 0;
            color: #333;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* ===== ì˜¤ëŠ˜ì˜ ì´ìŠˆ ìŠ¬ë¼ì´ë” ì˜ì—­ ===== */
        .hot-issues-section {
            position: relative;
            max-width: 1360px;
            margin: 0 auto;
            padding: 0 40px;
        }

        .news-slider-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .news-slider-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
            width: 100%;
        }

        .news-main-container {
            flex: 0 0 100%;
            box-sizing: border-box;
            display: flex;
            gap: 30px;
            padding: 20px;
            background: white;
        }

        .news-left {
            width: 65%;
            cursor: pointer;
        }

        .news-left img {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 8px;
        }

        .news-left h2 {
            font-size: 20px;
            font-weight: bold;
            margin: 15px 0 0 0;
            line-height: 1.4;
            color: #333;
        }

        .news-right {
            width: 35%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 0;
        }

        /* AI ìš”ì•½ ì„¹ì…˜ */
        .ai-summary-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            margin-bottom: 0;
        }

        .ai-summary-title {
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ai-summary-content {
            font-size: 14px;
            color: #444;
            line-height: 1.5;
        }

        .ai-summary-content ol {
            margin: 0;
            padding-left: 16px;
        }

        .ai-summary-content li {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        /* í€„ë¦¬í‹° ê·¸ë˜í”„ ì„¹ì…˜ */
        .quality-section {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
            margin-top: 0;
        }

        .quality-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .quality-charts {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .chart-container {
            text-align: center;
        }

        .chart-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .mini-chart {
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }

        .chart-score {
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
        }

        .quality-summary {
            font-size: 12px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            color: #555;
            text-align: left;
        }

        /* í†µì¼ëœ ì¢Œìš° ìŠ¬ë¼ì´ë”© ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-button:hover {
            background-color: #888;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .nav-left {
            left: 0;
        }

        .nav-right {
            right: 0;
        }

        /* ìŠ¬ë¼ì´ë” ì  í‘œì‹œ */
        .slider-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 20px 0 30px 0;
        }

        .slider-dots .dot {
            height: 15px;
            width: 15px;
            margin: 0 6px;
            background-color: #ccc;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .dot-label {
            font-size: 20px;
            font-weight: 700;
            color: black;
            padding: 8px 18px;
            border-radius: 24px;
            background-color: #c6f0ff;
            line-height: 1.2;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .slider-dots .dot.active {
            background-color: #007bff;
        }

        /* ===== AI ìš”ì•½ ì¹´ë“œ ë‰´ìŠ¤ ì˜ì—­ ===== */
        .ai-news-wrapper {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            position: relative;
        }

        .ai-news-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .ai-summary-scroll {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 20px;
            scroll-behavior: smooth;
            background-color: #f4f6f8;
            border-radius: 8px;
        }

        .ai-summary-item {
            flex: 0 0 auto;
            width: 280px;
            margin-right: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .ai-summary-item:hover {
            transform: translateY(-5px);
        }

        .ai-summary-item a {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .ai-summary-item img {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .ai-summary-item .content {
            padding: 15px;
        }

        .ai-summary-item .title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ai-summary-item .summary {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        /* AI ìš”ì•½ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .ai-summary-item .summary ol {
            margin: 0;
            padding-left: 18px;
            counter-reset: summary-counter;
        }

        .ai-summary-item .summary li {
            margin-bottom: 6px;
            line-height: 1.4;
            position: relative;
            list-style: none;
            counter-increment: summary-counter;
            padding-left: 0;
        }

        .ai-summary-item .summary li::before {
            content: counter(summary-counter) ". ";
            font-weight: bold;
            color: #007bff;
            position: absolute;
            left: -18px;
            top: 0;
        }

        /* ë§ì¤„ì„ ì²˜ë¦¬ ê°œì„  */
        .ai-summary-item .summary {
            max-height: 210px; /* ì•½ 6-7ì¤„ ì •ë„ì˜ ë†’ì´ë¡œ ëŒ€í­ ì¦ê°€ */
            overflow: hidden;
            position: relative;
        }

        .ai-summary-item .summary::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30px;
            height: 20px;
            background: linear-gradient(to right, transparent, white);
        }

        /* ===== ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ ì›Œë“œí´ë¼ìš°ë“œ ì˜ì—­ ===== */
        .wordcloud-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 20px;
            position: relative;
        }

        .wordcloud-box {
            width: 520px;
            height: 520px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 10px;
            position: relative;
            z-index: 1;
        }

        .news-list-container {
            width: 45%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            display: none;
        }

        .news-list-container.show {
            display: block;
        }

        .news-item {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            cursor: pointer;
        }

        .news-item img {
            width: 100px;
            height: 70px;
            object-fit: cover;
            margin-right: 16px;
            border-radius: 4px;
        }

        .news-item-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .news-item-media {
            font-size: 12px;
            color: #999;
        }

        .arrow-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .arrow-button:hover {
            background-color: #888;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .arrow-left {
            left: -70px;
        }

        .arrow-right {
            right: -70px;
        }

        .pagination-buttons {
            text-align: center;
            margin-top: 20px;
        }

        .pagination-buttons button {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            margin: 0 5px;
            cursor: pointer;
        }

        .pagination-buttons button:disabled {
            background-color: #cccccc;
            cursor: default;
        }
    </style>
</head>
<body>

<!-- âœ… ê³µí†µ ìƒë‹¨ë°” ì‚½ì… -->
<div th:replace="~{layout/common/header :: header}"></div>

<!-- ===== ì˜¤ëŠ˜ì˜ ì´ìŠˆ ì„¹ì…˜ ===== -->
<div class="section-title">ğŸ”¥ ì˜¤ëŠ˜ì˜ ì´ìŠˆ</div>

<div class="hot-issues-section">
    <!-- ì¢Œìš° ë²„íŠ¼ì„ ìŠ¬ë¼ì´ë” ë˜í¼ ë°”ê¹¥ì— ë°°ì¹˜ -->
    <button class="nav-button nav-left" onclick="manualPrevSlide()">â°</button>
    <button class="nav-button nav-right" onclick="manualNextSlide()">â±</button>

    <div class="news-slider-wrapper">
        <div class="news-slider-track" id="newsSliderTrack">
            <div class="news-main-container" th:each="article, iter : ${today_main_block_articles}"
                 th:attr="data-domain=${article.domain}">
                <div class="news-left" th:onclick="|window.location.href='/view/${article.id}'|">
                    <img th:src="@{${article.img_url}}" alt="ë‰´ìŠ¤ ì´ë¯¸ì§€" />
                    <h2 th:text="${article.title}">ë‰´ìŠ¤ ì œëª©</h2>
                </div>
                <div class="news-right">
                    <!-- AI ìš”ì•½ ì„¹ì…˜ -->
                    <div class="ai-summary-section">
                        <div class="ai-summary-title">
                            ğŸ§  AI ìš”ì•½
                        </div>
                        <div class="ai-summary-content">
                            <ol th:if="${article.summary != null and !#strings.isEmpty(article.summary)}">
                                <li th:each="line : ${#strings.arraySplit(article.summary, '.')}"
                                    th:if="${!#strings.isEmpty(#strings.trim(line))}"
                                    th:text="${#strings.trim(line) + '.'}">ìš”ì•½ í•­ëª©</li>
                            </ol>
                            <div th:if="${article.summary == null or #strings.isEmpty(article.summary)}">
                                AI ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>

                    <!-- í€„ë¦¬í‹° ë¶„ì„ ì„¹ì…˜ -->
                    <div class="quality-section">
                        <div class="quality-title">ğŸ“Š ê¸°ì‚¬ í€„ë¦¬í‹° ë¶„ì„</div>
                        <div class="quality-charts">
                            <div class="chart-container">
                                <div class="chart-label">ì œëª© í€„ë¦¬í‹°</div>
                                <canvas class="mini-chart title-chart" th:attr="data-article-id=${article.id}" width="80" height="80"></canvas>
                                <div class="chart-score title-score" th:attr="data-article-id=${article.id}">-</div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-label">ë³¸ë¬¸ í€„ë¦¬í‹°</div>
                                <canvas class="mini-chart content-chart" th:attr="data-article-id=${article.id}" width="80" height="80"></canvas>
                                <div class="chart-score content-score" th:attr="data-article-id=${article.id}">-</div>
                            </div>
                        </div>
                        <!-- ì œëª© ë° ë³¸ë¬¸ ë¶„ì„ ìš”ì•½ í…ìŠ¤íŠ¸ -->
                        <div class="quality-summary">
                            ì œëª©: <span class="best-title-type" th:attr="data-article-id=${article.id}">-</span><br>
                            ë³¸ë¬¸: <span class="dominant-content-type" th:attr="data-article-id=${article.id}">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="slider-dots" id="sliderDots"></div>
</div>

<!-- ìˆ¨ê²¨ì§„ í€„ë¦¬í‹° ë°ì´í„° ì €ì¥ì†Œ -->
<div id="qualityDataContainer" style="display: none;">
    <div th:each="article : ${today_main_block_articles}">
        <div th:attr="data-article-id=${article.id}">
            <!-- ì œëª© ì²´í¬ ë°ì´í„° -->
            <div class="title-checks-data">
                <div th:each="titleCheck : ${article.title_checks}"
                     th:attr="data-type=${titleCheck.content_check_type}, data-score=${titleCheck.score}">
                </div>
            </div>
            <!-- ë³¸ë¬¸ ì²´í¬ ë°ì´í„° -->
            <div class="content-checks-data">
                <div th:each="typeEntry : ${article.content_checks}">
                    <div th:each="keywordEntry : ${typeEntry.value}">
                        <div th:each="check : ${keywordEntry.value}"
                             th:attr="data-type=${check.content_check_type}, data-score=${check.score}, data-keyword=${check.keyword}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== AI ìš”ì•½ ì¹´ë“œ ë‰´ìŠ¤ ì„¹ì…˜ ===== -->
<div class="section-title">ğŸ§  AI ìš”ì•½ ë§Œí™” ë‰´ìŠ¤</div>

<div class="ai-news-wrapper">
    <div class="ai-news-container">
        <div class="ai-summary-scroll" onwheel="scrollHorizontally(event)">
            <div class="ai-summary-item" th:each="news : ${news_articles_for_comic}">
                <a th:href="@{/view/{id}(id=${news.id})}">
                    <img th:src="@{'/img/' + ${news.comics_url}}" alt="AI ìƒì„± ì´ë¯¸ì§€">
<!--                    <img th:src="@{/img/0db02033-b91b-4c93-88ee-527c18baf337.png}" alt="AI ìƒì„± ì´ë¯¸ì§€">-->
                    <div class="content">
                        <div class="title" th:text="${news.title}">ë‰´ìŠ¤ ì œëª©</div>
                        <div class="summary">
                            <ol th:if="${news.summary != null and !#strings.isEmpty(news.summary)}">
                                <li th:each="line : ${#strings.arraySplit(news.summary, '.')}"
                                    th:if="${!#strings.isEmpty(#strings.trim(line))}"
                                    th:text="${#strings.trim(line)}">ìš”ì•½ í•­ëª©</li>
                            </ol>
                            <div th:if="${news.summary == null or #strings.isEmpty(news.summary)}">
                                AI ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ===== ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ ì„¹ì…˜ ===== -->
<div class="section-title">ğŸ” ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ</div>

<div class="wordcloud-container">
    <button class="arrow-button arrow-left" onclick="prevDomain()">â°</button>

    <div>
        <div class="wordcloud-status" style="text-align:center; font-size:18px; font-weight:bold; margin-bottom: 10px;">
            <span id="currentDomainText"></span> |
            <span id="currentIndexText"></span>
        </div>
        <div id="wordCloudSlide" class="wordcloud-box"></div>
    </div>

    <div id="newsListContainer" class="news-list-container">
        <div id="selectedKeywordTitle" style="font-size: 18px; font-weight: bold; margin-bottom: 15px;"></div>
    </div>

    <button class="arrow-button arrow-right" onclick="nextDomain()">â±</button>
</div>

<script th:inline="javascript">
    // ì˜¤ëŠ˜ì˜ ì´ìŠˆ ìë™ ìŠ¬ë¼ì´ë“œ - ë³€ìˆ˜ ì„ ì–¸ ë¨¼ì €
    let currentSlide = 0;
    const slideIntervalTime = 5000; // 5ì´ˆ
    const slider = document.getElementById("newsSliderTrack");
    const slides = document.querySelectorAll(".news-main-container");
    const totalSlides = slides.length;
    let slideInterval = null;
    let resumeTimeout = null;

    function getKoreanTypeName(englishType) {
        const typeNames = {
            // ì œëª© ê´€ë ¨
            'title_normal': 'ì •ìƒ í‘œí˜„',
            'title_hidden_1': 'ì˜ë¬¸ ìœ ë°œ(ë¶€í˜¸)',
            'title_hidden_2': 'ì˜ë¬¸ ìœ ë°œ(ì€ë‹‰)',
            'title_sensation': 'ì„ ì • í‘œí˜„',
            'title_slang': 'ì†ì–´/ì¤„ì„ë§ ì‚¬ìš©',
            'title_over_representation': 'ê³¼ëŒ€ í‘œí˜„',
            'title_intentional_distortion': 'ì£¼ì–´ ì˜ë„ì  ì™œê³¡',

            // ë³¸ë¬¸ ê´€ë ¨
            'content_normal': 'ì •ìƒ í‘œí˜„',
            'content_advertisement_1': 'íŒë§¤ì •ë³´ ë…¸ì¶œ(ìƒí’ˆ)',
            'content_advertisement_2': 'íŒë§¤ì •ë³´ ë…¸ì¶œ(ë¶€ë™ì‚°)',
            'content_advertisement_3': 'íŒë§¤ì •ë³´ ë…¸ì¶œ(ì„œë¹„ìŠ¤)',
            'content_intentional_distortion': 'ì˜ë„ì  ìƒí™© ì™œê³¡'
        };

        return typeNames[englishType] || englishType;
    }


    // í€„ë¦¬í‹° ë°ì´í„° ì½ê¸° í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
    function getQualityData(articleId) {
        console.log('Getting quality data for article:', articleId);

        const container = document.querySelector(`#qualityDataContainer [data-article-id="${articleId}"]`);
        if (!container) {
            console.log('Container not found for article:', articleId);
            return { titleChecks: [], contentChecks: [] };
        }

        const titleChecks = [];
        const contentChecks = [];

        // ì œëª© ì²´í¬ ë°ì´í„° ì½ê¸°
        const titleCheckElements = container.querySelectorAll('.title-checks-data [data-type][data-score]');
        console.log('Found title check elements:', titleCheckElements.length);

        titleCheckElements.forEach(element => {
            const type = element.getAttribute('data-type');
            const score = parseFloat(element.getAttribute('data-score'));

            if (!isNaN(score)) {
                titleChecks.push({ type, score });
                console.log('Title check:', type, score);
            }
        });

        // ë³¸ë¬¸ ì²´í¬ ë°ì´í„° ì½ê¸°
        const contentCheckElements = container.querySelectorAll('.content-checks-data [data-type][data-score][data-keyword]');
        console.log('Found content check elements:', contentCheckElements.length);

        contentCheckElements.forEach(element => {
            const type = element.getAttribute('data-type');
            const score = parseFloat(element.getAttribute('data-score'));
            const keyword = element.getAttribute('data-keyword');

            if (!isNaN(score) && keyword) {
                contentChecks.push({ type, score, keyword });
                console.log('Content check:', type, score, keyword.substring(0, 30) + '...');
            }
        });

        console.log('Final quality data - Title checks:', titleChecks.length, 'Content checks:', contentChecks.length);
        return { titleChecks, contentChecks };
    }

    // ì œëª© í€„ë¦¬í‹° ì ìˆ˜ ê³„ì‚° (ìˆ˜ì •ëœ ë²„ì „ - title_normal ê¸°ì¤€)
    function calculateTitleQuality(titleChecks) {
        if (titleChecks.length === 0) return 0.5;

        // title_normal íƒ€ì…ì˜ ì ìˆ˜ë¥¼ ì°¾ê¸°
        const normalCheck = titleChecks.find(check => check.type === 'title_normal');

        if (normalCheck) {
            // title_normalì˜ ì ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (0~1 ë²”ìœ„)
            return Math.max(0, Math.min(1, normalCheck.score));
        } else {
            // title_normalì´ ì—†ìœ¼ë©´ ëª¨ë“  ì ìˆ˜ì˜ í‰ê·  ì‚¬ìš©
            let totalScore = 0;
            titleChecks.forEach(check => {
                totalScore += check.score;
            });
            const averageScore = totalScore / titleChecks.length;
            return Math.max(0, Math.min(1, averageScore));
        }
    }

    // ë³¸ë¬¸ í€„ë¦¬í‹° ì ìˆ˜ ê³„ì‚° (ìˆ˜ì •ëœ ë²„ì „)
    function calculateContentQuality(contentChecks) {
        if (contentChecks.length === 0) return 0.5;

        const keywordGroups = {};

        // í‚¤ì›Œë“œë³„ë¡œ ê·¸ë£¹í™”
        contentChecks.forEach(check => {
            if (check.type.startsWith('content_')) {
                if (!keywordGroups[check.keyword]) {
                    keywordGroups[check.keyword] = [];
                }
                keywordGroups[check.keyword].push(check);
            }
        });

        let totalSentences = 0;
        let normalSentences = 0;

        // ê° í‚¤ì›Œë“œ(ë¬¸ì¥)ë³„ë¡œ ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ íƒ€ì… í™•ì¸
        for (const keyword in keywordGroups) {
            const checks = keywordGroups[keyword];
            totalSentences++;

            // ê°€ì¥ ë†’ì€ ì ìˆ˜ì™€ í•´ë‹¹ íƒ€ì… ì°¾ê¸°
            let maxScore = 0;
            let maxType = null;

            checks.forEach(check => {
                if (check.score > maxScore) {
                    maxScore = check.score;
                    maxType = check.type;
                }
            });

            // ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ íƒ€ì…ì´ normalì´ë©´ ì •ìƒ ë¬¸ì¥
            if (maxType === 'content_normal') {
                normalSentences++;
            }
        }

        const quality = totalSentences > 0 ? normalSentences / totalSentences : 0.5;
        return quality;
    }

    // ë¯¸ë‹ˆ ë„ë„› ì°¨íŠ¸ ìƒì„±
    // ë¯¸ë‹ˆ ë„ë„› ì°¨íŠ¸ ìƒì„± (ìˆ˜ì •ëœ ë²„ì „)
    function createMiniDonutChart(canvas, quality, type) {
        const ctx = canvas.getContext('2d');
        const centerX = 40;
        const centerY = 40;
        const radius = 30;
        const innerRadius = 18;

        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        ctx.clearRect(0, 0, 80, 80);

        // ë°°ê²½ ì›
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
        ctx.fillStyle = '#f0f0f0';
        ctx.fill();

        // ì •ìƒ ë¹„ìœ¨ (íŒŒë€ìƒ‰) - quality ê°’ë§Œí¼
        if (quality > 0) {
            const normalAngle = 2 * Math.PI * quality;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -Math.PI/2, -Math.PI/2 + normalAngle);
            ctx.lineTo(centerX + Math.cos(-Math.PI/2 + normalAngle) * innerRadius,
                      centerY + Math.sin(-Math.PI/2 + normalAngle) * innerRadius);
            ctx.arc(centerX, centerY, innerRadius, -Math.PI/2 + normalAngle, -Math.PI/2, true);
            ctx.closePath();
            ctx.fillStyle = '#48dbfb'; // íŒŒë€ìƒ‰ (ì •ìƒ)
            ctx.fill();
        }

        // ë¹„ì •ìƒ ë¹„ìœ¨ (ë¹¨ê°„ìƒ‰) - (1-quality) ê°’ë§Œí¼
        if (quality < 1) {
            const normalAngle = 2 * Math.PI * quality;
            const problemAngle = 2 * Math.PI * (1 - quality);
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, -Math.PI/2 + normalAngle, -Math.PI/2 + normalAngle + problemAngle);
            ctx.lineTo(centerX + Math.cos(-Math.PI/2 + normalAngle + problemAngle) * innerRadius,
                      centerY + Math.sin(-Math.PI/2 + normalAngle + problemAngle) * innerRadius);
            ctx.arc(centerX, centerY, innerRadius, -Math.PI/2 + normalAngle + problemAngle, -Math.PI/2 + normalAngle, true);
            ctx.closePath();
            ctx.fillStyle = '#ff6b6b'; // ë¹¨ê°„ìƒ‰ (ë¹„ì •ìƒ)
            ctx.fill();
        }

        // ë‚´ë¶€ ì› (ë„ë„› êµ¬ë©)
        ctx.beginPath();
        ctx.arc(centerX, centerY, innerRadius, 0, 2 * Math.PI);
        ctx.fillStyle = 'white';
        ctx.fill();

        // ì¤‘ì•™ í…ìŠ¤íŠ¸ (ì •ìƒ ë¹„ìœ¨ í‘œì‹œ)
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${Math.round(quality * 100)}%`, centerX, centerY);
    }

    // ëª¨ë“  ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateQualityCharts() {
        const currentArticleContainer = slides[currentSlide];
        const articleElement = currentArticleContainer.querySelector('[data-article-id]');

        if (!articleElement) {
            console.log('Article element not found for slide:', currentSlide);
            return;
        }

        const articleId = articleElement.getAttribute('data-article-id');
        console.log('Updating charts for article:', articleId);

        const qualityData = getQualityData(articleId);
        console.log('Quality data:', qualityData);

        // ì œëª© í€„ë¦¬í‹° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        const titleCanvas = currentArticleContainer.querySelector('.title-chart');
        const titleScore = currentArticleContainer.querySelector('.title-score');

        if (titleCanvas && titleScore) {
            const titleQuality = calculateTitleQuality(qualityData.titleChecks);
            console.log('Title quality:', titleQuality);

            createMiniDonutChart(titleCanvas, titleQuality, 'title');
            titleScore.textContent = Math.round(titleQuality * 100) + '%';
        }

        // ë³¸ë¬¸ í€„ë¦¬í‹° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        const contentCanvas = currentArticleContainer.querySelector('.content-chart');
        const contentScoreElement = currentArticleContainer.querySelector('.content-score');

        if (contentCanvas && contentScoreElement) {
            const contentQuality = calculateContentQuality(qualityData.contentChecks);
            console.log('Content quality:', contentQuality);

            createMiniDonutChart(contentCanvas, contentQuality, 'content');
            contentScoreElement.textContent = Math.round(contentQuality * 100) + '%';
        }
        updateQualityTextSummary();  // ì œëª©/ë³¸ë¬¸ íƒ€ì… í‘œì‹œìš©
    }

    // ìˆ˜ì •ëœ ìŠ¬ë¼ì´ë“œ ì´ë™ í•¨ìˆ˜ë“¤
    function manualNextSlide() {
        currentSlide = (currentSlide + 1) % totalSlides;
        moveSlide(currentSlide);
        updateQualityCharts();
        resetAutoSlide();
    }

    function manualPrevSlide() {
        currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
        moveSlide(currentSlide);
        updateQualityCharts();
        resetAutoSlide();
    }

    function renderDots() {
        const dotsContainer = document.getElementById("sliderDots");
        dotsContainer.innerHTML = "";

        for (let i = 0; i < totalSlides; i++) {
            const slide = slides[i];
            const domain = slide.dataset.domain || `ìŠ¬ë¼ì´ë“œ ${i + 1}`;

            if (i === currentSlide) {
                const label = document.createElement("span");
                label.className = "dot-label";
                label.textContent = domain;
                dotsContainer.appendChild(label);
            } else {
                const dot = document.createElement("span");
                dot.className = "dot";
                dot.title = domain;

                dot.addEventListener("click", () => {
                    currentSlide = i;
                    moveSlide(currentSlide);
                    updateDots();
                    updateQualityCharts();
                    resetAutoSlide();
                });

                dotsContainer.appendChild(dot);
            }
        }
    }

    function updateDots() {
        renderDots();
    }

    function moveSlide(index) {
        const offset = -index * 100;
        slider.style.transform = `translateX(${offset}%)`;
        updateDots();
    }

    function startAutoSlide() {
        slideInterval = setInterval(() => {
            currentSlide = (currentSlide + 1) % totalSlides;
            moveSlide(currentSlide);
            updateQualityCharts();
        }, slideIntervalTime);
    }

    function stopAutoSlide() {
        clearInterval(slideInterval);
        slideInterval = null;
    }

    function resetAutoSlide() {
        stopAutoSlide();
        if (resumeTimeout) clearTimeout(resumeTimeout);
        resumeTimeout = setTimeout(() => {
            startAutoSlide();
        }, slideIntervalTime);
    }

    // ì´ˆê¸° ìŠ¬ë¼ì´ë“œ ì‹œì‘
    startAutoSlide();
    renderDots();
    updateDots();

    // ì´ˆê¸° ì°¨íŠ¸ ë¡œë“œ
    setTimeout(() => {
        updateQualityCharts();
    }, 100);

    // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ê°ì§€
    const container = document.querySelector(".news-slider-wrapper");
    container.addEventListener("mouseenter", () => {
        stopAutoSlide();
        if (resumeTimeout) clearTimeout(resumeTimeout);
    });

    container.addEventListener("mouseleave", () => {
        resetAutoSlide();
    });

    // AI ìš”ì•½ ì´ë¯¸ì§€ ìŠ¤í¬ë¡¤
    function scrollHorizontally(e) {
        const container = e.currentTarget;
        container.scrollLeft += e.deltaY;
        e.preventDefault();
    }

    // ì›Œë“œ í´ë¼ìš°ë“œ
    const issuesByDomain = [[${issuesByDomainJson}]];
    const domains = ["ì •ì¹˜", "ê²½ì œ", "ì‚¬íšŒ", "ì—°ì˜ˆ", "ìŠ¤í¬ì¸ "];
    let currentIndex = 0;
    let currentPage = 0;
    let currentKeyword = '';
    const pageSize = 5;
    let keywordNewsMap = {};

    const wordCloudSlide = d3.select("#wordCloudSlide");
    const newsListContainer = document.getElementById("newsListContainer");

    function renderWordCloud(domain) {
        const domainData = issuesByDomain[domain];
        const words = [];
        keywordNewsMap = {};
        currentPage = 0;

        domainData.main_block_top_keywords.forEach(keywordBlock => {
            const keyword = keywordBlock.keyword;
            const articles = keywordBlock.news_articles;

            words.push({ text: keyword, count: articles.length });
            keywordNewsMap[keyword] = articles;
        });

        const maxCount = Math.max(...words.map(w => w.count));
        const minCount = Math.min(...words.map(w => w.count));

        const normalizedWords = words.map(w => ({
            text: w.text,
            size: ((w.count - minCount) / (maxCount - minCount)) * 55 + 30
        }));

        const topWords = normalizedWords.sort((a, b) => b.size - a.size).slice(0, 40);

        d3.select("#wordCloudSlide svg").remove();

        const layout = d3.layout.cloud()
            .size([520, 520])
            .words(topWords)
            .padding(5)
            .rotate(() => 0)
            .font("Impact")
            .fontSize(d => d.size)
            .on("end", function(words) {
                draw(words);
            });

        layout.start();

        function draw(words) {
            const containerWidth = document.getElementById("wordCloudSlide").clientWidth;
            const containerHeight = document.getElementById("wordCloudSlide").clientHeight;

            const sortedWords = [...words].sort((a, b) => b.size - a.size);
            const total = sortedWords.length;
            const topThird = Math.floor(total / 3);
            const middleThird = Math.floor((total * 2) / 3);

            d3.select("#wordCloudSlide svg").remove();

            const svg = d3.select("#wordCloudSlide").append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${containerWidth / 2}, ${containerHeight / 2})`);

            svg.selectAll("text")
                .data(words)
                .enter().append("text")
                .attr("class", "word")
                .style("font-size", d => d.size + "px")
                .style("font-family", "'Segoe UI Semibold', 'Arial', sans-serif")
                .style("font-weight", "600")
                .style("fill", d => {
                    const rank = sortedWords.findIndex(w => w.text === d.text);
                    if (rank < topThird) return "#FF7F0E";
                    else if (rank < middleThird) return "#1F77B4";
                    else return "#A6A6A6";
                })
                .attr("text-anchor", "middle")
                .attr("transform", d => "translate(" + [d.x, d.y] + ")")
                .text(d => d.text);

            $("#wordCloudSlide text").on("click", function () {
                const keyword = d3.select(this).text();
                currentKeyword = keyword;
                currentPage = 0;
                showPaginatedNews(currentPage);
            });

            currentKeyword = sortedWords[0].text;
            showPaginatedNews(0);
        }
        clearNews();
    }

    function clearNews() {
        // newsListContainer.innerHTML = "";
        // newsListContainer.classList.remove("show");
    }

    function showPaginatedNews(page) {
        newsListContainer.innerHTML = "";
        newsListContainer.classList.add("show");

        const titleDiv = document.createElement("div");
        titleDiv.id = "selectedKeywordTitle";
        titleDiv.textContent = `ğŸ” ì„ íƒëœ í‚¤ì›Œë“œ: ${currentKeyword}`;
        titleDiv.style.fontSize = "18px";
        titleDiv.style.fontWeight = "bold";
        titleDiv.style.marginBottom = "15px";
        newsListContainer.appendChild(titleDiv);

        const articles = keywordNewsMap[currentKeyword] || [];
        const startIdx = page * pageSize;
        const endIdx = startIdx + pageSize;
        const paginatedNews = articles.slice(startIdx, endIdx);

        paginatedNews.forEach(news => {
            const item = document.createElement("div");
            item.className = "news-item";
            item.onclick = () => window.location.href = '/view/' + news.id;

            item.innerHTML = `
                <img src="${news.img_url}" alt="ë‰´ìŠ¤ ì´ë¯¸ì§€">
                <div class="news-item-content">
                    <div class="news-item-title">${news.title}</div>
                    <div class="news-item-media">${news.media}</div>
                </div>
            `;
            newsListContainer.appendChild(item);
        });

        renderPaginationButtons(articles);
    }

    function renderPaginationButtons(articles) {
        const paginationDiv = document.createElement("div");
        paginationDiv.className = "pagination-buttons";

        const prevBtn = document.createElement("button");
        prevBtn.textContent = "ì´ì „";
        prevBtn.disabled = currentPage === 0;
        prevBtn.onclick = () => {
            currentPage--;
            showPaginatedNews(currentPage);
        };

        const nextBtn = document.createElement("button");
        nextBtn.textContent = "ë‹¤ìŒ";
        nextBtn.disabled = (currentPage + 1) * pageSize >= articles.length;
        nextBtn.onclick = () => {
            currentPage++;
            showPaginatedNews(currentPage);
        };

        paginationDiv.appendChild(prevBtn);
        paginationDiv.appendChild(nextBtn);
        newsListContainer.appendChild(paginationDiv);
    }

    function updateStatusText() {
        document.getElementById("currentDomainText").textContent = "ë¶„ì•¼: " + domains[currentIndex];
        document.getElementById("currentIndexText").textContent = (currentIndex + 1) + " / " + domains.length;
    }

    function nextDomain() {
        currentIndex = (currentIndex + 1) % domains.length;
        renderWordCloud(domains[currentIndex]);
        updateStatusText();
    }

    function prevDomain() {
        currentIndex = (currentIndex - 1 + domains.length) % domains.length;
        renderWordCloud(domains[currentIndex]);
        updateStatusText();
    }
    function getBestTitleType(titleChecks) {
        if (!titleChecks || titleChecks.length === 0) return "-";
        const sorted = [...titleChecks].sort((a, b) => b.score - a.score);
        return getKoreanTypeName(sorted[0].type);
    }

    function getDominantContentType(contentChecks) {
        if (!contentChecks || contentChecks.length === 0) return "-";

        const keywordGroups = {};

        // í‚¤ì›Œë“œ ê¸°ì¤€ìœ¼ë¡œ content_ íƒ€ì…ë§Œ ê·¸ë£¹í™”
        contentChecks.forEach(check => {
            if (check.type.startsWith("content_")) {
                if (!keywordGroups[check.keyword]) keywordGroups[check.keyword] = [];
                keywordGroups[check.keyword].push(check);
            }
        });

        let total = 0;
        let problemCount = 0;
        const typeCount = {};

        for (const keyword in keywordGroups) {
            const checks = keywordGroups[keyword];
            total++;

            let maxScore = 0;
            let maxType = null;
            checks.forEach(check => {
                if (check.score > maxScore) {
                    maxScore = check.score;
                    maxType = check.type;
                }
            });

            if (maxType !== "content_normal" && maxScore > 0.3) {
                problemCount++;
                typeCount[maxType] = (typeCount[maxType] || 0) + 1;
            }
        }
        console.log("ğŸŸ¢ total:", total);
        console.log("ğŸŸ¡ problemCount:", problemCount);
        console.log("ğŸ”´ typeCount:", typeCount);

        if (problemCount === 0) {
            console.log("âœ… ëª¨ë“  ë¬¸ì¥ì´ ì •ìƒ â†’ ë³¸ë¬¸: ì •ìƒ");
            return "ì •ìƒ í‘œí˜„";
        }
        // ì „ì²´ ë¬¸ì¥ ì¤‘ 30% ì´ìƒì´ì–´ì•¼ ìœ ì˜ë¯¸
        const sortedTypes = Object.entries(typeCount).sort((a, b) => b[1] - a[1]);
        for (const [type, count] of sortedTypes) {
            if ((count / total) >= 0.3) {
                return getKoreanTypeName(type);
            }
        }
        return getKoreanTypeName(sortedTypes[0][0]);
    }

    function updateQualityTextSummary() {
        const currentArticleContainer = slides[currentSlide];
        const articleElement = currentArticleContainer.querySelector('[data-article-id]');
        if (!articleElement) return;

        const articleId = articleElement.getAttribute('data-article-id');
        const qualityData = getQualityData(articleId);

        // ì œëª© íƒ€ì… í‘œì‹œ
        const titleSpan = currentArticleContainer.querySelector('.best-title-type');
        if (titleSpan) {
            titleSpan.textContent = getBestTitleType(qualityData.titleChecks);
        }

        // ë³¸ë¬¸ ì£¼ìš” íƒ€ì… í‘œì‹œ
        const contentSpan = currentArticleContainer.querySelector('.dominant-content-type');
        if (contentSpan) {
            contentSpan.textContent = getDominantContentType(qualityData.contentChecks);
        }
        console.log("ë³¸ë¬¸ span ëŒ€ìƒ:", contentSpan);
    }

    renderWordCloud(domains[currentIndex]);
    updateStatusText();
<!--    updateQualityTextSummary();-->
</script>
</body>
</html>