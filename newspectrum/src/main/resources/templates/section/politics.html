<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:inline="javascript">
<head>
    <meta charset="UTF-8">
    <title>ì •ì¹˜ ë‰´ìŠ¤ - NewSpectrum</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <style>
        body {
          margin: 0;
          font-family: sans-serif;
          background: #f4f6f8;
        }

        .top-news-section {
            background-color: #d6eaff; /* ì—°í•œ íŒŒë‘ ì „ì²´ ë°°ê²½ */
            padding: 40px 0;
        }
        .top-news-wrapper {
            max-width: 1200px;
            background-color: #ffffff;
            border-radius: 12px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .top-news-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        /* ìƒë‹¨ ëŒ€í‘œ ë‰´ìŠ¤ */
        .main-news {
          background: #fff;
          padding: 20px;
          border-radius: 0;
          display: flex;
          flex-direction: column;
          border-right: 1px solid #e0e0e0;
        }

        .main-news img {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .main-news .text {
          padding: 0 5px;
        }

        .main-news h2 {
          font-size: 24px;
          margin: 0;
          color: #1a1a1a;
        }

        .main-news .meta-info {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-top: 10px;
          flex-wrap: nowrap;
        }

        .main-news .media {
          color: #777;
          font-size: 14px;
          white-space: nowrap;
          flex-shrink: 0;
        }

        /* ì˜¤ë¥¸ìª½ 2x2 ì¹´ë“œ ë‰´ìŠ¤ */
        .card-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
        }

        .card {
          background: #fff;
          border-radius: 0;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          border-bottom: 1px solid #e0e0e0;
          padding: 5px;
          margin-top: 15px;
          box-sizing: border-box;
        }

        .card img {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 6px;
            border-bottom: 12px
        }

        .card .text {
          padding: 0;
        }

        .card .content {
          display: -webkit-box;
          -webkit-line-clamp: 2;  /* ìµœëŒ€ ì¤„ ìˆ˜ (ì˜ˆ: 2ì¤„) */
          -webkit-box-orient: vertical;
          overflow: hidden;
          text-overflow: ellipsis;
          font-size: 13px;
          color: #666;
          line-height: 1.5em;
          height: 3em;  /* 2ì¤„ = line-height * 2 */
          margin-top: 6px;
        }

        .card h4 {
          display: -webkit-box;
          -webkit-line-clamp: 2;  /* ìµœëŒ€ ì¤„ ìˆ˜ (ì˜ˆ: 2ì¤„) */
          -webkit-box-orient: vertical;
          overflow: hidden;
          text-overflow: ellipsis;
          font-size: 14px;
          margin: 0;
          color: #1a1a1a;
          line-height: 1.5em;
          height: 3em;  /* 2ì¤„ = line-height * 2 */
        }

        .card .meta-info {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-top: 5px;
          flex-wrap: nowrap;
        }

        .card .media {
          font-size: 12px;
          color: #888;
          white-space: nowrap;
          flex-shrink: 0;
        }

        /* í€„ë¦¬í‹° ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .quality-badges {
          display: flex;
          gap: 5px;
          flex-wrap: wrap;
          flex-shrink: 1;
        }

        .quality-badge {
          display: inline-flex;
          align-items: center;
          padding: 2px 6px;
          border-radius: 10px;
          font-size: 10px;
          font-weight: bold;
          color: white;
          gap: 2px;
          white-space: nowrap;
          flex-shrink: 0;
        }

        .quality-badge.title-good {
          background-color: #28a745; /* ì´ˆë¡ìƒ‰ */
        }

        .quality-badge.title-bad {
          background-color: #dc3545; /* ë¹¨ê°„ìƒ‰ */
        }

        .quality-badge.content-good {
          background-color: #28a745; /* ì´ˆë¡ìƒ‰ */
        }

        .quality-badge.content-bad {
          background-color: #dc3545; /* ë¹¨ê°„ìƒ‰ */
        }

        /* í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ ë‰´ìŠ¤ */
        .bottom-news-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .bottom-news-container {
          background: #fff;
          border-radius: 10px;
          overflow: hidden;
          margin: 30px 0;
        }
        .bottom-news-list .list-item {
          display: flex;
          align-items: center;
          padding: 16px 20px;
        }
        .bottom-news-list .list-item + .list-item {
          border-top: 1px solid #eee;
        }

        .list-item img {
          width: 180px;
          height: 130px;
          object-fit: cover;
          border-radius: 6px;
          margin-right: 15px;
        }

        .list-item .text {
          flex: 1;
        }

        .list-item .content {
          display: -webkit-box;
          -webkit-line-clamp: 2; /* ë‘ ì¤„ë§Œ í‘œì‹œ */
          -webkit-box-orient: vertical;
          overflow: hidden;
          text-overflow: ellipsis;
          font-size: 14px;
          color: #555;
          line-height: 1.5em;
          height: 3.0em;
          margin-top: 4px;
        }

        .list-item h5 {
          font-size: 20px;
          margin: 0;
          color: #000000;
        }

        .list-item .meta-info {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-top: 5px;
          flex-wrap: nowrap;
        }

        .list-item .media {
          font-size: 13px;
          color: #666;
          white-space: nowrap;
          flex-shrink: 0;
        }

        .list-item .date {
          font-size: 12px;
          color: #999;
          white-space: nowrap;
          flex-shrink: 0;
        }

        .list-item .keywords {
          font-size: 12px;
          color: #007bff;
          flex-shrink: 1;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
        }

        .list-item .keywords .keyword {
          margin-right: 6px;
          font-weight: 500;
        }

        /* ê³µí†µ ë§í¬ ë°‘ì¤„ ì œê±° */
        .main-news a,
        .card a,
        .list-item a {
          text-decoration: none;
          color: inherit;
        }

        .main-news a:hover,
        .card a:hover,
        .list-item a:hover {
          text-decoration: none;
        }

        /* í˜ì´ì§€ë„¤ì´ì…˜ */
        .pagination {
          text-align: center;
          margin: 30px 0;
        }

        .pagination button {
          margin: 0 4px;
          padding: 6px 12px;
          background-color: transparent;
          color: #000;
          border: none;
          border-radius: 50%;
          font-size: 14px;
          width: 36px;
          height: 36px;
          line-height: 1;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .pagination button:hover {
          background-color: #e6f0ff; /* hover ì‹œ ì˜…ì€ íŒŒë€ìƒ‰ */
        }

        .pagination button.active {
          background-color: #d0e7ff; /* í™œì„±í™”ëœ ë²„íŠ¼: ì˜…ì€ íŒŒë€ìƒ‰ */
          color: #007bff;
          font-weight: bold;
        }
    </style>
</head>
<body>

<!--  ê³µí†µ ìƒë‹¨ë°” -->
<div th:replace="layout/common/header :: header"></div>

<!-- ìˆ¨ê²¨ì§„ í€„ë¦¬í‹° ë°ì´í„° ì €ì¥ì†Œ -->
<div id="qualityDataContainer" style="display: none;">
    <div th:each="article : ${news_article}">
        <div th:attr="data-article-id=${article.id}">
            <!-- ì œëª© ì²´í¬ ë°ì´í„° -->
            <div class="title-checks-data">
                <div th:each="titleCheck : ${article.title_checks}"
                     th:attr="data-type=${titleCheck.content_check_type}, data-score=${titleCheck.score}">
                </div>
            </div>
            <!-- ë³¸ë¬¸ ì²´í¬ ë°ì´í„° -->
            <div class="content-checks-data">
                <div th:each="typeEntry : ${article.content_checks}">
                    <div th:each="keywordEntry : ${typeEntry.value}">
                        <div th:each="check : ${keywordEntry.value}"
                             th:attr="data-type=${check.content_check_type}, data-score=${check.score}, data-keyword=${check.keyword}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="top-news-section">
    <div class="top-news-wrapper">
        <!--  ìƒë‹¨ ë‰´ìŠ¤ 5ê°œ -->
        <div class="top-news-grid">
            <!-- ëŒ€í‘œ ë‰´ìŠ¤ (ì™¼ìª½) -->
            <div class="main-news" th:if="${news_article.size() > 0}">
                <a th:href="@{/view/{id}(id=${news_article[0].id})}">
                    <img th:src="${news_article[0].img_url}" alt="ëŒ€í‘œ ì´ë¯¸ì§€">
                    <div class="text">
                        <h2 th:text="${news_article[0].title}">ëŒ€í‘œ ë‰´ìŠ¤ ì œëª©</h2>
                        <div class="meta-info">
                            <span class="media" th:text="${news_article[0].media}">ì–¸ë¡ ì‚¬</span>
                            <div class="quality-badges" th:attr="data-article-id=${news_article[0].id}">
                                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            <!-- ì¹´ë“œí˜• ë‰´ìŠ¤ 4ê°œ (ì˜¤ë¥¸ìª½) -->
            <div class="card-grid">
                <div class="card"
                     th:each="article, stat : ${news_article}"
                     th:if="${stat.index >= 1 and stat.index <= 4}">
                    <a th:href="@{/view/{id}(id=${article.id})}">
                        <img th:src="${article.img_url}" alt="ì¹´ë“œ ì´ë¯¸ì§€">
                        <div class="text">
                            <h4 th:text="${article.title}">ì¹´ë“œ ë‰´ìŠ¤ ì œëª©</h4>
                            <p class="content" th:utext="${article.content}">ë³¸ë¬¸ ìš”ì•½ ë‚´ìš©ì…ë‹ˆë‹¤. ì´ ë‚´ìš©ì€ 2ì¤„ê¹Œì§€ë§Œ ë³´ì—¬ì§€ê³  ì´í›„ëŠ” ...ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                            <div class="meta-info">
                                <!--                                <span class="media" th:text="${article.media}">ì–¸ë¡ ì‚¬</span>-->
                                <div class="quality-badges" th:attr="data-article-id=${article.id}">
                                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ë¦¬ìŠ¤íŠ¸ ë‰´ìŠ¤ -->
<div class="bottom-news-section">
    <div class="bottom-news-wrapper">
        <div class="bottom-news-container">
            <div class="bottom-news-list" id="newsContainer"></div>
        </div>
    </div>
</div>

<!--í˜ì´ì§€ë²„íŠ¼-->
<div class="pagination" id="paginationContainer"></div>

<!-- JavaScript ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§• -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const allArticles = [[${news_article}]];
    const articlesPerPage = 10;
    let currentPage = 0;

    // í€„ë¦¬í‹° ë°ì´í„° ì½ê¸° í•¨ìˆ˜
    function getQualityData(articleId) {
        const container = document.querySelector(`#qualityDataContainer [data-article-id="${articleId}"]`);
        if (!container) {
            return { titleChecks: [], contentChecks: [] };
        }

        const titleChecks = [];
        const contentChecks = [];

        // ì œëª© ì²´í¬ ë°ì´í„° ì½ê¸°
        const titleCheckElements = container.querySelectorAll('.title-checks-data [data-type][data-score]');
        titleCheckElements.forEach(element => {
            const type = element.getAttribute('data-type');
            const score = parseFloat(element.getAttribute('data-score'));
            if (!isNaN(score)) {
                titleChecks.push({ type, score });
            }
        });

        // ë³¸ë¬¸ ì²´í¬ ë°ì´í„° ì½ê¸°
        const contentCheckElements = container.querySelectorAll('.content-checks-data [data-type][data-score][data-keyword]');
        contentCheckElements.forEach(element => {
            const type = element.getAttribute('data-type');
            const score = parseFloat(element.getAttribute('data-score'));
            const keyword = element.getAttribute('data-keyword');
            if (!isNaN(score) && keyword) {
                contentChecks.push({ type, score, keyword });
            }
        });

        return { titleChecks, contentChecks };
    }

    // ì œëª© í€„ë¦¬í‹° íŒì • (title_normalì´ ê°€ì¥ ë†’ìœ¼ë©´ ì •ìƒ)
    function analyzeTitleQuality(titleChecks) {
        if (titleChecks.length === 0) return { isGood: true, reason: 'ë°ì´í„° ì—†ìŒ' };

        // ëª¨ë“  ì²´í¬ì˜ ìµœê³  ì ìˆ˜ ì°¾ê¸°
        let maxScore = 0;
        let maxType = null;

        titleChecks.forEach(check => {
            if (check.score > maxScore) {
                maxScore = check.score;
                maxType = check.type;
            }
        });

        // title_normalì´ ê°€ì¥ ë†’ì€ ì ìˆ˜ë¥¼ ê°€ì§€ë©´ ì •ìƒ
        const isGood = maxType === 'title_normal';
        return { isGood, maxType, maxScore };
    }

    // ë³¸ë¬¸ í€„ë¦¬í‹° íŒì • (ë¬¸ì œ ë¬¸ì¥ ë¹„ìœ¨ 30% ì´í•˜ë©´ ì •ìƒ)
    function analyzeContentQuality(contentChecks) {
        if (contentChecks.length === 0) return { isGood: true, ratio: 0 };

        const keywordGroups = {};

        // í‚¤ì›Œë“œë³„ë¡œ ê·¸ë£¹í™” (content_ íƒ€ì…ë§Œ)
        contentChecks.forEach(check => {
            if (check.type.startsWith('content_')) {
                if (!keywordGroups[check.keyword]) {
                    keywordGroups[check.keyword] = [];
                }
                keywordGroups[check.keyword].push(check);
            }
        });

        let totalSentences = 0;
        let problemSentences = 0;

        // ê° í‚¤ì›Œë“œ(ë¬¸ì¥)ë³„ë¡œ ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ íƒ€ì… í™•ì¸
        for (const keyword in keywordGroups) {
            const checks = keywordGroups[keyword];
            totalSentences++;

            // ê°€ì¥ ë†’ì€ ì ìˆ˜ì™€ í•´ë‹¹ íƒ€ì… ì°¾ê¸°
            let maxScore = 0;
            let maxType = null;

            checks.forEach(check => {
                if (check.score > maxScore) {
                    maxScore = check.score;
                    maxType = check.type;
                }
            });

            // normalì´ ì•„ë‹ˆê³  ì„ê³„ê°’(0.3) ì´ìƒì´ë©´ ë¬¸ì œ ë¬¸ì¥
            if (maxType !== 'content_normal' && maxScore > 0.3) {
                problemSentences++;
            }
        }

        const ratio = totalSentences > 0 ? (problemSentences / totalSentences) : 0;
        // const isGood = ratio <= 0.3; // 30% ì´í•˜ë©´ ì •ìƒ
        const isGood = ratio <= 0.001; // í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì •ìƒ

        return { isGood, ratio, problemSentences, totalSentences };
    }

    // í€„ë¦¬í‹° ë°°ì§€ ìƒì„±
    function createQualityBadges(articleId) {
        const qualityData = getQualityData(articleId);
        const titleAnalysis = analyzeTitleQuality(qualityData.titleChecks);
        const contentAnalysis = analyzeContentQuality(qualityData.contentChecks);

        let badgesHtml = '';

        // ì œëª© í€„ë¦¬í‹° ë°°ì§€
        if (titleAnalysis.isGood) {
            badgesHtml += '<span class="quality-badge title-good">ğŸ“ ì œëª©ì–‘í˜¸</span>';
        } else {
            badgesHtml += '<span class="quality-badge title-bad">âš ï¸ ì œëª©ì£¼ì˜</span>';
        }

        // ë³¸ë¬¸ í€„ë¦¬í‹° ë°°ì§€
        if (contentAnalysis.isGood) {
            badgesHtml += '<span class="quality-badge content-good">ğŸ“° ë³¸ë¬¸ì–‘í˜¸</span>';
        } else {
            badgesHtml += '<span class="quality-badge content-bad">ğŸš¨ ë³¸ë¬¸ì£¼ì˜</span>';
        }

        return badgesHtml;
    }

    // ìƒë‹¨ ë‰´ìŠ¤ë“¤ì˜ í€„ë¦¬í‹° ë°°ì§€ ì—…ë°ì´íŠ¸
    function updateTopNewsQuality() {
        const qualityBadgeContainers = document.querySelectorAll('.quality-badges[data-article-id]');

        qualityBadgeContainers.forEach(container => {
            const articleId = container.getAttribute('data-article-id');
            container.innerHTML = createQualityBadges(articleId);
        });
    }

    // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${month}-${day} ${hours}:${minutes}`;
    }

    // í‚¤ì›Œë“œ í¬ë§·íŒ… í•¨ìˆ˜ (ìµœëŒ€ 5ê°œ)
    function formatKeywords(keywords) {
        if (!keywords || keywords.length === 0) return '';
        const displayKeywords = keywords.slice(0, 5);
        return displayKeywords.map(keyword => `#${keyword}`).join(' ');
    }

    function renderArticles() {
      const container = document.getElementById("newsContainer");
      container.innerHTML = "";

      const start = 5 + currentPage * articlesPerPage;
      const end = Math.min(start + articlesPerPage, allArticles.length);

      for (let i = start; i < end; i++) {
        const article = allArticles[i];
        const div = document.createElement("div");
        div.className = "list-item";

        // í€„ë¦¬í‹° ë°°ì§€ HTML ìƒì„±
        const qualityBadgesHtml = createQualityBadges(article.id);

        // ë‚ ì§œì™€ í‚¤ì›Œë“œ í¬ë§·íŒ…
        const formattedDate = formatDate(article.createdDate);
        const formattedKeywords = formatKeywords(article.keywords);

        div.innerHTML = `
          <a href="/view/${article.id}" style="display: flex; align-items: center; text-decoration: none;">
            <img src="${article.img_url}" alt="ì¸ë„¤ì¼">
            <div class="text">
              <h5>${article.title}</h5>
              <p class="content">${article.content}</p>
              <div class="meta-info">
                <span class="media">${article.media}</span>
                <span class="date">${formattedDate}</span>
                <span class="keywords">${formattedKeywords}</span>
                <div class="quality-badges">
                  ${qualityBadgesHtml}
                </div>
              </div>
            </div>
          </a>
        `;
        container.appendChild(div);
      }
    }

    function renderPagination() {
      const totalPages = Math.ceil((allArticles.length - 5) / articlesPerPage);
      const paginationContainer = document.getElementById("paginationContainer");
      paginationContainer.innerHTML = "";

      const groupSize = 10;
      const currentGroup = Math.floor(currentPage / groupSize);
      const startPage = currentGroup * groupSize;
      const endPage = Math.min(startPage + groupSize, totalPages);

      if (startPage > 0) {
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "â—€";
        prevBtn.onclick = () => {
          currentPage -= 1;
          renderArticles();
          renderPagination();
        };
        paginationContainer.appendChild(prevBtn);
      }

      for (let i = startPage; i < endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i + 1;
        if (i === currentPage) btn.classList.add("active");
        btn.onclick = () => {
          currentPage = i;
          renderArticles();
          renderPagination();
        };
        paginationContainer.appendChild(btn);
      }

      if (endPage < totalPages) {
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "â–¶";
        nextBtn.onclick = () => {
          currentPage += 1;
          renderArticles();
          renderPagination();
        };
        paginationContainer.appendChild(nextBtn);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // ìƒë‹¨ ë‰´ìŠ¤ë“¤ì˜ í€„ë¦¬í‹° ë°°ì§€ ì—…ë°ì´íŠ¸
      updateTopNewsQuality();

      // í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ ë‰´ìŠ¤ ë Œë”ë§
      renderArticles();
      renderPagination();
    });
    /*]]>*/
</script>

</body>
</html>